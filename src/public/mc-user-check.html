<!DOCTYPE html>
<html>

	<head>
		<title>Our Funky HTML Page</title>
		<meta name="description" content="Our first page">
		<meta name="keywords" content="html tutorial template">
	</head>
	<body>
		<input type="text" id="inbox">
		<button onclick="ev()">check</button>

		<p id="outbox"></p>



		<script>
			// adapted from https://gist.github.com/jomo/be7dbb5228187edbb993#file-track-js
			"use strict";
			const CORS_PROXY = "https://api.codetabs.com/v1/proxy?quest=";
			const inbox = document.getElementById("inbox");
			const outbox = document.getElementById("outbox");

			async function ev() {
				outbox.innerText = "Loading...";
				const outv = await track(inbox.value);
				outbox.innerText = new Date(outv*1000).toLocaleString();
			}

			async function check(name, num) {
				const url = `https://api.mojang.com/users/profiles/minecraft/${name}?at=${num}`;
				return (await fetch(CORS_PROXY + url)).status;
			};

			async function track(name, a, b, lastfail) {
				a = a || 1263146630; // notch sign-up
				b = b || Math.floor(Date.now() / 1000);
				lastfail = lastfail || 0;

				if (a === b) {
					const ok = await check(name, a)
					if (ok && lastfail === a - 1) {
						console.log("found:", new Date(a * 1000).toUTCString());
					} else {
						if (lastfail === 0) {
							console.log("target is <= " + a);
						} else {
							console.log("target is > " + a);
						}

						return a;
					}
				} else {
					const mid = a + Math.floor((b - a) / 2);
					const ok = await check(name, mid);
					if (ok) {
						console.log("range: " + a + "\t<-|  \t" + b);
						return track(name, a, mid, lastfail);
					} else {
						console.log("range: " + a + "\t  |->\t" + b);
						return track(name, mid + 1, b, mid);
					}
				}
			}
		</script>
	</body>

</html>
